<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UGCET 2025 Enhanced Counselling System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --primary: #1e40af; --accent: #3b82f6; --success: #10b981; --danger: #ef4444;
            --bg: #f8fafc; --surface: #ffffff; --text: #0f172a; --text-muted: #64748b; --border: #e2e8f0;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .container { max-width: 100%; padding: 1rem; }
        .header { background: linear-gradient(135deg, var(--primary), #1e3a8a); color: white; padding: 1.5rem; margin: -1rem -1rem 1rem -1rem; text-align: center; }
        .header h1 { font-size: 1.5rem; font-weight: 800; margin-bottom: 0.25rem; }
        .header p { font-size: 0.875rem; opacity: 0.9; }
        .card { background: var(--surface); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card h2 { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; }
        .login-screen { max-width: 400px; margin: 2rem auto; }
        .tabs { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem; background: var(--bg); padding: 0.25rem; border-radius: 10px; }
        .tab { padding: 0.75rem; border: none; background: transparent; color: var(--text-muted); font-size: 0.95rem; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all 0.3s; font-family: 'Inter', sans-serif; }
        .tab.active { background: var(--primary); color: white; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.875rem; border: 2px solid var(--border); background: var(--surface); color: var(--text); border-radius: 10px; font-size: 1rem; font-family: 'Inter', sans-serif; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
        .btn { width: 100%; padding: 1rem; border: none; background: var(--primary); color: white; font-size: 1rem; font-weight: 700; border-radius: 10px; cursor: pointer; font-family: 'Inter', sans-serif; }
        .btn:active { transform: scale(0.98); }
        .btn-small { padding: 0.5rem 1rem; width: auto; font-size: 0.875rem; }
        .btn-success { background: var(--success); }
        .btn-secondary { background: var(--border); color: var(--text); }
        .checkbox-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem; margin-top: 0.5rem; max-height: 300px; overflow-y: auto; }
        .checkbox-label { display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem; background: var(--bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 0.875rem; }
        .checkbox-label input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-label input[type="checkbox"]:checked + span { color: var(--primary); font-weight: 600; }
        .user-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: var(--surface); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .user-name { font-weight: 700; font-size: 1rem; }
        .user-email { font-size: 0.75rem; color: var(--text-muted); }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
        .results-count { font-size: 1rem; font-weight: 600; color: var(--text-muted); }
        .filters { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
        .filter-input { width: 100%; padding: 0.75rem; border: 2px solid var(--border); background: var(--surface); color: var(--text); border-radius: 8px; font-size: 0.9rem; font-family: 'Inter', sans-serif; }
        .table-container { background: var(--surface); border-radius: 12px; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { padding: 0.75rem 0.5rem; text-align: left; font-weight: 700; background: var(--bg); border-bottom: 2px solid var(--border); position: sticky; top: 0; font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--border); }
        .college-code { font-weight: 700; color: var(--primary); white-space: nowrap; }
        .cutoff-rank { font-weight: 600; color: var(--success); }
        .error { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; }
        .success { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); color: var(--success); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; }
        .loading-indicator { position: fixed; top: 0; left: 0; right: 0; background: var(--primary); color: white; padding: 0.75rem; text-align: center; z-index: 1000; font-size: 0.9rem; font-weight: 600; }
        .hidden { display: none; }
        .info-box { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--accent); color: var(--primary); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; font-size: 0.9rem; }
        @media (min-width: 768px) {
            .container { padding: 2rem; }
            .header { margin: -2rem -2rem 2rem -2rem; padding: 2rem; }
            .header h1 { font-size: 2rem; }
            table { font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div id="loadingIndicator" class="loading-indicator hidden">‚è≥ Loading college data...</div>
    
    <div class="container">
        <div id="loginScreen" class="login-screen">
            <div class="card">
                <h2>üéì UGCET Counselling 2025</h2>
                <p style="text-align: center; margin-bottom: 1.5rem; color: var(--text-muted);">Enhanced Counselling System with Smart Recommendations</p>
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('login')">Login</button>
                    <button class="tab" onclick="switchTab('signup')">Sign Up</button>
                </div>
                <div id="errorMessage" class="error hidden"></div>
                <div id="successMessage" class="success hidden"></div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>
                <form id="signupForm" class="hidden">
                    <div class="form-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" required placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" required placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" required placeholder="Choose a password">
                    </div>
                    <button type="submit" class="btn">Create Account</button>
                </form>
            </div>
        </div>

        <div id="dashboard" class="hidden">
            <div class="header">
                <h1>üéì UGCET Counselling 2025</h1>
                <p>Enhanced System with Smart Rank Ranges & Complete Filtering</p>
            </div>

            <div class="user-bar">
                <div>
                    <div class="user-name" id="userName"></div>
                    <div class="user-email" id="userEmail"></div>
                </div>
                <button class="btn btn-small btn-secondary" onclick="logout()">Logout</button>
            </div>

            <div class="card">
                <h2>üìù Your Preferences</h2>
                <form id="preferencesForm">
                    <div class="form-group">
                        <label for="studentRank">Your UGCET Rank *</label>
                        <input type="number" id="studentRank" required placeholder="Enter your rank">
                        <div id="rankInfo" class="info-box hidden" style="margin-top: 0.5rem;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">Category *</label>
                        <select id="category" required>
                            <option value="">Select Category</option>
                            <option value="GM">General Merit (GM)</option>
                            <option value="1G">Category 1 (1G)</option>
                            <option value="2AG">Category 2A (2AG)</option>
                            <option value="2BG">Category 2B (2BG)</option>
                            <option value="3AG">Category 3A (3AG)</option>
                            <option value="3BG">Category 3B (3BG)</option>
                            <option value="SCG">SC Category (SCG)</option>
                            <option value="STG">ST Category (STG)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Special Reservations</label>
                        <div class="checkbox-group" style="max-height: none;">
                            <label class="checkbox-label">
                                <input type="checkbox" name="reservation" value="K">
                                <span>Kannada Medium (K)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="reservation" value="R">
                                <span>Rural (R)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="reservation" value="H">
                                <span>Hyderabad Karnataka (H)</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Preferred Districts</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="district" value="BLR">
                                <span>Bangalore</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="district" value="MYS">
                                <span>Mysore</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="district" value="MNG">
                                <span>Mangalore</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="district" value="BLM">
                                <span>Belgaum</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="district" value="HBL">
                                <span>Hubli</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="district" value="DWD">
                                <span>Dharwad</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="district" value="TMK">
                                <span>Tumkur</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="district" value="ALL">
                                <span>All Districts</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Preferred Branches (Each specialization is separate)</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="CS">
                                <span>Computer Science (Pure)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="CS-AIML">
                                <span>CS - AI & ML</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="CS-DS">
                                <span>CS - Data Science</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="CS-CYB">
                                <span>CS - Cyber Security</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="CS-IOT">
                                <span>CS - IoT</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="AIML">
                                <span>AI & ML (Standalone)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="DS">
                                <span>Data Science (Standalone)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="IS">
                                <span>Information Science</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="EC">
                                <span>Electronics & Communication</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="EE">
                                <span>Electrical & Electronics</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="ME">
                                <span>Mechanical Engineering</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="CE">
                                <span>Civil Engineering</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="AE">
                                <span>Aerospace Engineering</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="branch" value="ALL">
                                <span>All Branches</span>
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn">üîç Find Colleges (Smart Range)</button>
                </form>
            </div>

            <div id="resultsSection" class="hidden">
                <div class="card">
                    <div class="results-header">
                        <div class="results-count" id="resultsCount">0 colleges found</div>
                        <button class="btn btn-small btn-success" onclick="downloadResults()">‚¨á Download Excel</button>
                    </div>

                    <div class="filters">
                        <input type="text" class="filter-input" id="searchCollege" placeholder="üîç Search college..." onkeyup="filterResults()">
                        <input type="text" class="filter-input" id="searchBranch" placeholder="üîç Search branch..." onkeyup="filterResults()">
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Code</th>
                                    <th>College</th>
                                    <th>Branch</th>
                                    <th>District</th>
                                    <th>R1</th>
                                    <th>R2</th>
                                    <th>R3</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-muted);">Enter your preferences to see results</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BRANCH_NAMES = {
            'CS': 'Computer Science', 'CS-AIML': 'CS - AI & ML', 'CS-DS': 'CS - Data Science',
            'CS-CYB': 'CS - Cyber Security', 'CS-IOT': 'CS - IoT', 'AIML': 'AI & ML',
            'DS': 'Data Science', 'IS': 'Information Science', 'EC': 'Electronics & Communication',
            'EE': 'Electrical & Electronics', 'ME': 'Mechanical', 'CE': 'Civil', 'AE': 'Aerospace'
        };
        
        const DISTRICT_NAMES = {
            'BLR': 'Bangalore', 'MYS': 'Mysore', 'MNG': 'Mangalore', 'BLM': 'Belgaum',
            'HBL': 'Hubli', 'DWD': 'Dharwad', 'TMK': 'Tumkur', 'OTH': 'Other'
        };

        let collegeData = [];
        let currentUser = null;
        let filteredResults = [];
        let allResults = [];
        let dataLoaded = false;
        let searchCriteria = {};

        window.addEventListener('load', async () => {
            checkLogin();
            await loadData();
            setupRankListener();
        });

        async function loadData() {
            const indicator = document.getElementById('loadingIndicator');
            indicator.classList.remove('hidden');
            
            try {
                const response = await fetch('data.json');
                if (!response.ok) throw new Error('Failed to load');
                
                const compactData = await response.json();
                
                collegeData = compactData.map(row => ({
                    code: row.c,
                    college: row.n,
                    branch: row.b,
                    district: row.d,
                    category: row.t,
                    isHK: row.h === 1,
                    ranks: row.r
                }));
                
                dataLoaded = true;
                indicator.classList.add('hidden');
                console.log(`‚úÖ Loaded ${collegeData.length} records`);
            } catch (error) {
                indicator.classList.add('hidden');
                alert('Failed to load data. Please refresh the page.');
            }
        }

        function calculateRankRange(rank) {
            let lower, upper;
            if (rank < 10000) {
                lower = Math.max(0, rank - 5000);
                upper = rank + 5000;
            } else if (rank < 50000) {
                lower = Math.max(0, rank - 8500);
                upper = rank + 8500;
            } else if (rank < 100000) {
                lower = Math.max(0, rank - 12500);
                upper = rank + 12500;
            } else if (rank < 200000) {
                lower = Math.max(0, rank - 25000);
                upper = rank + 25000;
            } else {
                lower = Math.max(0, rank - 45000);
                upper = rank + 45000;
            }
            return { lower, upper };
        }

        function setupRankListener() {
            document.getElementById('studentRank').addEventListener('input', (e) => {
                const rank = parseInt(e.target.value);
                const infoBox = document.getElementById('rankInfo');
                
                if (rank && !isNaN(rank)) {
                    const range = calculateRankRange(rank);
                    infoBox.textContent = `‚ú® Smart Range: Will show colleges with cutoffs from ${range.lower.toLocaleString()} to ${range.upper.toLocaleString()}`;
                    infoBox.classList.remove('hidden');
                } else {
                    infoBox.classList.add('hidden');
                }
            });
        }

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('signupForm').classList.add('hidden');
                tabs[0].classList.add('active');
            } else {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('signupForm').classList.remove('hidden');
                tabs[1].classList.add('active');
            }
            hideError();
            hideSuccess();
        }

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const userKey = `user_${email}`;
                const userData = localStorage.getItem(userKey);
                
                if (!userData) {
                    showError('Account not found. Please sign up first.');
                    return;
                }

                const user = JSON.parse(userData);
                if (user.password !== password) {
                    showError('Incorrect password.');
                    return;
                }

                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showDashboard();
            } catch (error) {
                showError('Login failed.');
            }
        });

        document.getElementById('signupForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const name = document.getElementById('signupName').value;

            try {
                const userKey = `user_${email}`;
                const existingUser = localStorage.getItem(userKey);
                
                if (existingUser) {
                    showError('Account exists. Please login.');
                    return;
                }

                const userData = { email, password, name, createdAt: new Date().toISOString() };
                localStorage.setItem(userKey, JSON.stringify(userData));
                
                currentUser = userData;
                localStorage.setItem('currentUser', JSON.stringify(userData));
                showSuccess('Account created!');
                setTimeout(() => showDashboard(), 1000);
            } catch (error) {
                showError('Signup failed.');
            }
        });

        document.getElementById('preferencesForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!dataLoaded) {
                alert('Data is still loading. Please wait...');
                return;
            }
            findColleges();
        });

        function findColleges() {
            const rank = parseInt(document.getElementById('studentRank').value);
            const category = document.getElementById('category').value;
            const reservations = Array.from(document.querySelectorAll('input[name="reservation"]:checked')).map(cb => cb.value);
            const districts = Array.from(document.querySelectorAll('input[name="district"]:checked')).map(cb => cb.value);
            const branches = Array.from(document.querySelectorAll('input[name="branch"]:checked')).map(cb => cb.value);

            if (!rank || !category) {
                alert('Please enter your rank and select category');
                return;
            }

            // Calculate smart rank range
            const rankRange = calculateRankRange(rank);
            
            // Determine if HK data should be used
            const useHK = reservations.includes('H');
            const hasKannada = reservations.includes('K');
            const hasRural = reservations.includes('R');
            
            // Store search criteria for Excel download
            searchCriteria = {
                rank,
                category,
                reservations: reservations.join(', '),
                districts: districts.map(d => DISTRICT_NAMES[d] || d).join(', '),
                branches: branches.map(b => BRANCH_NAMES[b] || b).join(', '),
                rankRange: `${rankRange.lower.toLocaleString()} - ${rankRange.upper.toLocaleString()}`,
                date: new Date().toLocaleString()
            };

            // Filter data
            let results = collegeData.filter(row => {
                // Category match
                if (row.category !== category) return false;
                
                // HK filter
                if (row.isHK !== useHK) return false;
                
                // District filter
                const includeAllDistricts = districts.includes('ALL');
                if (!includeAllDistricts && districts.length > 0) {
                    if (!districts.includes(row.district)) return false;
                }
                
                // Branch filter
                const includeAllBranches = branches.includes('ALL');
                if (!includeAllBranches && branches.length > 0) {
                    if (!branches.includes(row.branch)) return false;
                }
                
                // Check rank range
                let rankIndices = [];
                if (useHK) {
                    // HK data: [R1H, R2H, R3H, R1HK, R2HK, R3HK, R1HR, R2HR, R3HR]
                    if (hasKannada) rankIndices = [3, 4, 5];
                    else if (hasRural) rankIndices = [6, 7, 8];
                    else rankIndices = [0, 1, 2];
                } else {
                    // Main data: [R1, R2, R3, R1K, R2K, R3K, R1R, R2R, R3R]
                    if (hasKannada) rankIndices = [3, 4, 5];
                    else if (hasRural) rankIndices = [6, 7, 8];
                    else rankIndices = [0, 1, 2];
                }
                
                const qualifies = rankIndices.some(i => {
                    const cutoff = row.ranks[i];
                    return cutoff && cutoff >= rankRange.lower && cutoff <= rankRange.upper;
                });
                
                return qualifies;
            });

            // Sort by best cutoff
            results.sort((a, b) => {
                const getCutoff = (row) => {
                    let indices = [];
                    if (useHK) {
                        if (hasKannada) indices = [3, 4, 5];
                        else if (hasRural) indices = [6, 7, 8];
                        else indices = [0, 1, 2];
                    } else {
                        if (hasKannada) indices = [3, 4, 5];
                        else if (hasRural) indices = [6, 7, 8];
                        else indices = [0, 1, 2];
                    }
                    for (let i of indices) {
                        if (row.ranks[i]) return row.ranks[i];
                    }
                    return Infinity;
                };
                return getCutoff(a) - getCutoff(b);
            });

            allResults = results;
            filteredResults = results;
            displayResults(results);
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsTableBody');
            const resultsSection = document.getElementById('resultsSection');
            const resultsCount = document.getElementById('resultsCount');

            resultsSection.classList.remove('hidden');
            resultsCount.textContent = `${results.length} college${results.length !== 1 ? 's' : ''} found`;

            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-muted);">No colleges found. Try adjusting your criteria.</td></tr>';
                return;
            }

            const reservations = Array.from(document.querySelectorAll('input[name="reservation"]:checked')).map(cb => cb.value);
            const useHK = reservations.includes('H');
            const hasKannada = reservations.includes('K');
            const hasRural = reservations.includes('R');
            
            let rankIndices = [];
            if (useHK) {
                if (hasKannada) rankIndices = [3, 4, 5];
                else if (hasRural) rankIndices = [6, 7, 8];
                else rankIndices = [0, 1, 2];
            } else {
                if (hasKannada) rankIndices = [3, 4, 5];
                else if (hasRural) rankIndices = [6, 7, 8];
                else rankIndices = [0, 1, 2];
            }

            tbody.innerHTML = results.map((row, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td class="college-code">${row.code}</td>
                    <td title="${row.college}">${row.college}</td>
                    <td>${BRANCH_NAMES[row.branch] || row.branch}</td>
                    <td>${DISTRICT_NAMES[row.district] || row.district}</td>
                    <td class="cutoff-rank">${row.ranks[rankIndices[0]] || '-'}</td>
                    <td class="cutoff-rank">${row.ranks[rankIndices[1]] || '-'}</td>
                    <td class="cutoff-rank">${row.ranks[rankIndices[2]] || '-'}</td>
                </tr>
            `).join('');
        }

        function filterResults() {
            const searchCollege = document.getElementById('searchCollege').value.toLowerCase();
            const searchBranch = document.getElementById('searchBranch').value.toLowerCase();

            let filtered = allResults.filter(row => {
                const collegeName = row.college.toLowerCase();
                const branchName = (BRANCH_NAMES[row.branch] || row.branch).toLowerCase();
                
                if (searchCollege && !collegeName.includes(searchCollege)) return false;
                if (searchBranch && !branchName.includes(searchBranch)) return false;
                
                return true;
            });

            filteredResults = filtered;
            displayResults(filtered);
        }

        function downloadResults() {
            if (filteredResults.length === 0) {
                alert('No results to download');
                return;
            }

            const reservations = Array.from(document.querySelectorAll('input[name="reservation"]:checked')).map(cb => cb.value);
            const useHK = reservations.includes('H');
            const hasKannada = reservations.includes('K');
            const hasRural = reservations.includes('R');
            
            let rankIndices = [];
            if (useHK) {
                if (hasKannada) rankIndices = [3, 4, 5];
                else if (hasRural) rankIndices = [6, 7, 8];
                else rankIndices = [0, 1, 2];
            } else {
                if (hasKannada) rankIndices = [3, 4, 5];
                else if (hasRural) rankIndices = [6, 7, 8];
                else rankIndices = [0, 1, 2];
            }

            // Create enhanced CSV with student info
            const headers = [
                'UGCET 2025 College Counselling Results',
                '',
                `Student Name: ${currentUser.name}`,
                `Email: ${currentUser.email}`,
                `Rank: ${searchCriteria.rank}`,
                `Category: ${searchCriteria.category}`,
                `Reservations: ${searchCriteria.reservations || 'None'}`,
                `Preferred Districts: ${searchCriteria.districts || 'All'}`,
                `Preferred Branches: ${searchCriteria.branches || 'All'}`,
                `Rank Range Searched: ${searchCriteria.rankRange}`,
                `Search Date: ${searchCriteria.date}`,
                '',
                'Results (Sorted by Cutoff Rank):',
                'S.No,College Code,College Name,Branch,District,Round 1,Round 2,Round 3'
            ];

            const rows = filteredResults.map((row, idx) => {
                const escapeCsv = (str) => {
                    if (!str) return '';
                    str = String(str);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };
                
                return [
                    idx + 1,
                    escapeCsv(row.code),
                    escapeCsv(row.college),
                    escapeCsv(BRANCH_NAMES[row.branch] || row.branch),
                    escapeCsv(DISTRICT_NAMES[row.district] || row.district),
                    row.ranks[rankIndices[0]] || '-',
                    row.ranks[rankIndices[1]] || '-',
                    row.ranks[rankIndices[2]] || '-'
                ].join(',');
            });

            const csvContent = [...headers, ...rows].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `UGCET_Results_${currentUser.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function checkLogin() {
            const stored = localStorage.getItem('currentUser');
            if (stored) {
                currentUser = JSON.parse(stored);
                showDashboard();
            }
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('signupForm').reset();
            document.getElementById('preferencesForm').reset();
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 3000);
        }

        function hideSuccess() {
            document.getElementById('successMessage').classList.add('hidden');
        }
    </script>
</body>
</html>
